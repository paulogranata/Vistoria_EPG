<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#D4A574">
    <meta name="description" content="PWA Profissional para Vistorias Imobili√°rias - Emilio Paulo Granata CRECI 50.583">
    
    <title>Vistoria Imobili√°ria Premium | CRECI 50.583</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Brush+Script+MT&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <!-- MARCA D'√ÅGUA FIXA (CORRE√á√ÉO #16b) -->
    <img src="icon-512.png" alt="" class="marca-dagua" id="marca-dagua">

    <div id="status-bar" class="status-bar">
        <span id="network-status">üü¢ Online</span>
        <span id="battery-status"></span>
        <span id="storage-status"></span>
    </div>

    <div class="app-container">
        
        <!-- CABE√áALHO COM LOGO (CORRE√á√ÉO #16a) -->
        <header class="app-header">
            <img src="icon-512.png" alt="Emilio Paulo Granata - Servi√ßos T√©cnicos Imobili√°rios" class="logo-header" id="logo-header">
        </header>

        <!-- T√çTULO DO LAUDO (CORRE√á√ÉO #20) -->
        <section class="section-card titulo-laudo-container">
            <div class="titulo-laudo-selecao">
                <label class="radio-titulo">
                    <input type="radio" name="tipo-laudo" value="normal" id="radio-laudo-normal" checked>
                    <input type="text" id="titulo-laudo-normal" class="titulo-editavel" value="LAUDO DE VISTORIA IMOBILI√ÅRIA">
                </label>
                
                <label class="radio-titulo">
                    <input type="radio" name="tipo-laudo" value="complementar" id="radio-laudo-complementar">
                    <input type="text" id="titulo-laudo-complementar" class="titulo-editavel titulo-menor" value="LAUDO DE VISTORIA IMOBILI√ÅRIA COMPLEMENTAR">
                </label>
            </div>

            <!-- TEXTO COMPLEMENTAR (CORRE√á√ÉO #20c/20d) -->
            <div id="texto-complementar" class="texto-complementar" style="display:none;">
                <label for="frase-complementar">Texto complementar (edit√°vel):</label>
                <textarea id="frase-complementar" rows="3" class="textarea-complementar">Este laudo complementa o levantamento de constata√ß√µes apontadas em vistoria no mesmo endere√ßo, ocorrida no dia dd/mm/aaaa.</textarea>
            </div>
        </section>

        <!-- CHECK-IN OBRIGAT√ìRIO COM GPS N√ÉO-BLOQUEANTE (CORRE√á√ÉO #12) -->
        <section id="section-checkin" class="section-card">
            <h1 class="section-title">CHECK-IN OBRIGAT√ìRIO</h1>
            
            <div id="checkin-pending" class="checkin-pending">
                <div class="gps-status">
                    <div class="spinner"></div>
                    <p id="gps-status-text">üìç Obtendo localiza√ß√£o GPS...</p>
                </div>
                
                <button id="btn-checkin" class="btn-primary btn-large" disabled>
                    <span class="btn-icon">üìç</span>
                    CHEGADA AO LOCAL
                </button>
                
                <p class="checkin-note">Aguarde o GPS ou use localiza√ß√£o manual</p>
            </div>

            <!-- FALLBACK MANUAL (CORRE√á√ÉO #12 - GPS FALHOU) -->
            <div id="checkin-manual" class="checkin-manual" style="display:none;">
                <div class="fallback-card">
                    <h3>üìç Localiza√ß√£o Manual</h3>
                    <p>GPS indispon√≠vel. Digite a localiza√ß√£o do im√≥vel:</p>
                    
                    <div class="form-group">
                        <input 
                            type="text" 
                            id="input-localizacao-manual" 
                            class="form-input"
                            placeholder="Ex: Terreno 12, Quadra A, Canoas/RS"
                            list="localizacoes-salvas"
                        >
                        <datalist id="localizacoes-salvas"></datalist>
                    </div>
                    
                    <button id="btn-checkin-manual" class="btn-primary btn-large">
                        <span class="btn-icon">üìù</span>
                        CONFIRMAR LOCALIZA√á√ÉO
                    </button>
                    
                    <button id="btn-retry-gps" class="btn-secondary btn-outline" style="margin-top: 10px;">
                        <span class="btn-icon">üîÑ</span>
                        Tentar GPS Novamente
                    </button>
                </div>
            </div>

            <div id="checkin-complete" class="checkin-complete" style="display:none;">
                <div class="checkin-info">
                    <h3>‚úÖ Check-in Realizado</h3>
                    <div class="checkin-details">
                        <p><strong>üìç Localiza√ß√£o:</strong> <span id="checkin-coords"></span></p>
                        <p><strong>üïê Data/Hora:</strong> <span id="checkin-datetime"></span></p>
                        <p><strong>üåô Adicional Noturno:</strong> <span id="checkin-noturno"></span></p>
                    </div>
                    
                    <div class="tempo-espera">
                        <p><strong>‚è±Ô∏è Tempo de Espera:</strong> <span id="tempo-espera">00:00:00</span></p>
                        <p class="tempo-note" id="tempo-note" style="display:none;"></p>
                    </div>
                </div>

                <!-- FOTOS DE CHEGADA (CORRE√á√ÉO #18) -->
                <div id="fotos-chegada-section" class="fotos-chegada-section">
                    <h3>Fotos de Chegada</h3>
                    <div class="fotos-chegada-acoes">
                        <button id="btn-foto-chegada" class="btn-secondary">
                            <span class="btn-icon">üì∑</span>
                            FOTO
                        </button>
                        <button id="btn-mais-foto-chegada" class="btn-secondary btn-outline">
                            <span class="btn-icon">+</span>
                            FOTO
                        </button>
                    </div>
                    <div id="galeria-fotos-chegada" class="galeria-fotos"></div>
                    <p class="foto-counter-chegada">
                        <strong>Fotos de chegada:</strong> <span id="total-fotos-chegada">0</span>
                    </p>
                </div>

                <button id="btn-impedimento" class="btn-danger btn-outline">
                    üö´ IMPEDIMENTO DE ACESSO
                </button>
            </div>
        </section>

        <!-- SE√á√ÉO 1: DADOS DO IM√ìVEL -->
        <section id="section-1" class="section-card locked" style="display:none;">
            <h1 class="section-title">1. DADOS DO IM√ìVEL</h1>

            <!-- 1a. CONTRATANTE COM GLOSS√ÅRIO EDIT√ÅVEL (CORRE√á√ÉO #1) -->
            <div class="form-group">
                <label for="contratante">1a. Contratante:</label>
                <div class="glossario-select-container">
                    <select id="prefixo-contratante" class="prefixo-select">
                        <option value="">Prefixo...</option>
                        <option value="Imobili√°ria:">Imobili√°ria:</option>
                        <option value="Propriet√°rio:">Propriet√°rio:</option>
                        <option value="Locat√°rio:">Locat√°rio:</option>
                    </select>
                    <input type="text" id="contratante" list="contratantes-list" class="form-input contratante-input" placeholder="Digite o nome...">
                </div>
                <datalist id="contratantes-list"></datalist>
            </div>

            <div class="form-group">
                <label for="endereco">1b. Endere√ßo do Im√≥vel:</label>
                <input type="text" id="endereco" class="form-input" placeholder="Rua, n√∫mero, complemento, bairro, cidade">
            </div>

            <div class="form-group">
                <label for="tipo-imovel">1c. Tipo de Im√≥vel:</label>
                <select id="tipo-imovel" class="form-select">
                    <option value="">Selecione...</option>
                    <option value="Residencial">Residencial</option>
                    <option value="Comercial">Comercial</option>
                    <option value="Terreno">Terreno</option>
                </select>
            </div>

            <div class="form-group">
                <label for="tipologia">1d. Tipologia:</label>
                <input type="text" id="tipologia" list="tipologias-list" class="form-input" placeholder="Selecione o tipo primeiro...">
                <datalist id="tipologias-list"></datalist>
            </div>

            <div class="form-group">
                <label for="modalidade">1e. Modalidade de Vistoria:</label>
                <select id="modalidade" class="form-select">
                    <option value="">Selecione...</option>
                    <option value="Vistoria de entrada">Vistoria de entrada</option>
                    <option value="Vistoria de sa√≠da">Vistoria de sa√≠da</option>
                    <option value="Vistoria fotogr√°fica (registro)">Vistoria fotogr√°fica (registro)</option>
                    <option value="Vistoria de entrega de chaves" data-hide-for="Terreno">Vistoria de entrega de chaves</option>
                    <option value="Vistoria de confer√™ncias diversas">Vistoria de confer√™ncias diversas</option>
                    <option value="Vistoria de recebimento para venda">Vistoria de recebimento para venda</option>
                    <option value="Vistoria Peri√≥dica">Vistoria Peri√≥dica</option>
                </select>
            </div>

            <div class="form-group">
                <label for="faixa-metragem">1f. Faixa de Metragem:</label>
                <select id="faixa-metragem" class="form-select">
                    <option value="">Selecione o tipo primeiro...</option>
                </select>
            </div>
        </section>

        <!-- SE√á√ÉO 2: VISTORIA -->
        <section id="section-2" class="section-card locked" style="display:none;">
            <h1 class="section-title">2. VISTORIA DE <span id="tipo-ambiente">C√îMODOS</span></h1>

            <div id="blocos-vistoria">
                <!-- Blocos din√¢micos -->
            </div>

            <button id="btn-adicionar-bloco" class="btn-secondary btn-outline">
                <span class="btn-icon">+</span>
                ADICIONAR AMBIENTE
            </button>

            <div class="foto-counter-total">
                <strong>N¬∫ total de fotos:</strong> <span id="total-fotos-global">0</span>
            </div>
        </section>

        <!-- SE√á√ÉO 3: ASSINATURAS -->
        <section id="section-3" class="section-card locked" style="display:none;">
            <h1 class="section-title">3. ASSINATURAS</h1>

            <div class="assinatura-vistoriador">
                <label>3a. Vistoriador:</label>
                <div class="assinatura-imagem">
                    <!-- CORRE√á√ÉO #3: SVG MANUSCRITO 500x120 -->
                    <svg viewBox="0 0 500 120" class="assinatura-svg" xmlns="http://www.w3.org/2000/svg">
                        <text x="20" y="80" font-family="'Brush Script MT', cursive" font-size="56" fill="#003366" opacity="0.9">
                            Emilio Paulo Granata
                        </text>
                    </svg>
                </div>
                <p class="assinatura-info">Emilio Paulo Granata - CRECI 50.583</p>
            </div>

            <div id="assinaturas-clientes">
                <!-- Assinaturas din√¢micas -->
            </div>

            <button id="btn-nova-assinatura" class="btn-secondary btn-outline">
                <span class="btn-icon">+</span>
                Nova Assinatura
            </button>

            <!-- ADICIONAIS POR ESCOPO VIS√çVEIS NA TELA (CORRE√á√ÉO #5) -->
            <div class="adicionais-escopo">
                <h3>Adicionais por Escopo</h3>
                <div class="adicionais-grid">
                    <label class="checkbox-label">
                        <input type="checkbox" id="adicional-mobiliado" value="mobiliado">
                        <span>Im√≥vel mobiliado</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="adicional-benfeitorias" value="benfeitorias">
                        <span>Terreno com benfeitorias/estruturas</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="adicional-urgencia" value="urgencia">
                        <span>Urg√™ncia (entrega em 24h)</span>
                    </label>
                    <label class="checkbox-label" id="label-noturno" style="opacity: 0.5; pointer-events: none;">
                        <input type="checkbox" id="adicional-noturno" value="noturno" disabled>
                        <span>Vistoria noturna (18h √†s 08h)</span>
                    </label>
                    <label class="checkbox-label" id="label-tempo-espera" style="display:none;">
                        <input type="checkbox" id="adicional-tempo-espera" value="tempo-espera" disabled checked>
                        <span>Tempo de espera (&gt;20min)</span>
                    </label>
                </div>
            </div>

            <!-- CERTIFICA√á√ÉO +50% MAIOR (CORRE√á√ÉO #19 + #9) -->
            <div class="certificacao-autenticidade">
                <h3>CERTIFICA√á√ÉO DE AUTENTICIDADE</h3>
                <p>Este laudo de vistoria √© um documento pericial inviol√°vel, certificado pela identifica√ß√£o do Vistoriador Emilio Paulo Granata, contendo evid√™ncias fotogr√°ficas gravadas com coordenadas geogr√°ficas de precis√£o (GPS) e carimbo de data/hora, assegurando a integridade e a veracidade das condi√ß√µes do im√≥vel no ato da inspe√ß√£o.</p>
            </div>
        </section>

        <!-- BOT√ïES DE A√á√ÉO -->
        <section id="section-actions" class="section-card locked" style="display:none;">
            <button id="btn-gerar-pdf" class="btn-primary btn-large">
                <span class="btn-icon">üìÑ</span>
                GERAR PDF
            </button>

            <div class="btn-group">
                <button id="btn-enviar-email" class="btn-secondary" disabled>
                    <span class="btn-icon">üìß</span>
                    ENVIO E-MAIL
                </button>
                <button id="btn-enviar-whatsapp" class="btn-secondary" disabled>
                    <span class="btn-icon">üì±</span>
                    ENVIO WHATSAPP
                </button>
            </div>

            <button id="btn-limpar-formulario" class="btn-danger btn-outline">
                <span class="btn-icon">üóëÔ∏è</span>
                LIMPAR FORMUL√ÅRIO
            </button>
        </section>

    </div>

    <!-- MODAIS E OVERLAYS -->
    <div id="pdf-overlay" class="pdf-overlay" style="display:none;">
        <div class="pdf-progress-card">
            <h2>Gerando PDF...</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p class="progress-text">
                <span id="progress-percent">0%</span> - 
                Processando foto <span id="current-photo">0</span> de <span id="total-photos">0</span>
            </p>
            <p class="progress-note">Aguarde, n√£o feche o aplicativo</p>
        </div>
    </div>

    <div id="modal-impedimento" class="modal" style="display:none;">
        <div class="modal-content">
            <h2>‚ö†Ô∏è CONFIRMAR IMPEDIMENTO DE ACESSO</h2>
            <div class="form-group">
                <label>Motivo do impedimento:</label>
                <select id="motivo-impedimento" class="form-select">
                    <option value="Aus√™ncia de chaves">Aus√™ncia de chaves</option>
                    <option value="Negativa de entrada">Negativa de entrada</option>
                    <option value="Aus√™ncia das partes">Aus√™ncia das partes</option>
                    <option value="Outro">Outro</option>
                </select>
                <input type="text" id="motivo-outro" class="form-input" placeholder="Especifique..." style="display:none; margin-top: 10px;">
            </div>
            <p class="modal-valor">Valor cobrado: <strong id="valor-impedimento">R$ 0,00</strong> (50% do valor base)</p>
            <div class="modal-actions">
                <button id="btn-cancelar-impedimento" class="btn-secondary">CANCELAR</button>
                <button id="btn-confirmar-impedimento" class="btn-danger">GERAR AUTO</button>
            </div>
        </div>
    </div>

    <canvas id="photo-canvas" style="display:none;"></canvas>
    <canvas id="thumbnail-canvas" style="display:none;"></canvas>

    <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none;" multiple>
    <input type="file" id="file-input" accept="image/*" style="display:none;" multiple>
    <input type="file" id="camera-input-chegada" accept="image/*" capture="environment" style="display:none;" multiple>

    <script src="app.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('‚úÖ Service Worker v1.2 registrado'))
                .catch(err => console.error('‚ùå Erro ao registrar SW:', err));
        }
    </script>
</body>
</html>
